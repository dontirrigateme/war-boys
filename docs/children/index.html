<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Children</title>
  <link rel="stylesheet" href="./children.css" />
  <link rel="stylesheet" href="../style.css" />
</head>
<body>
  <main class="wrap">
    <h1>Children</h1>

    <div class="toolbar">
      <input id="search" type="search" placeholder="Search name…" />
      <select id="fatherPicker"></select>
      <select id="sortPicker">
        <option value="name_asc">Name ↑</option>
        <option value="name_desc">Name ↓</option>
        <option value="age_desc">Age (oldest first)</option>
        <option value="age_asc">Age (youngest first)</option>
      </select>
    </div>

    <div id="results" class="grid"></div>
  </main>

  <script src="./children.js" defer></script>
</body>
</html>  fatherPicker.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.textContent = "— All fathers —";
  ph.selected = true;
  fatherPicker.appendChild(ph);
  for (const f of fathers) {
    const opt = document.createElement("option");
    opt.value = f;
    opt.textContent = f;
    fatherPicker.appendChild(opt);
  }
}

function hookEvents() {
  fatherPicker.addEventListener("change", render);
  sortPicker.addEventListener("change", render);
  search.addEventListener("input", render);
}

function render() {
  const term = search.value.trim().toLowerCase();
  const father = fatherPicker.value;

  let rows = children.filter(c =>
    (!father || c._fatherName === father) &&
    (!term || c._name.toLowerCase().includes(term))
  );

  // sorting
  const mode = sortPicker.value;
  rows.sort((a,b) => {
    if (mode === "age_desc") return (b.age_days||0) - (a.age_days||0);
    if (mode === "age_asc")  return (a.age_days||0) - (b.age_days||0);
    if (mode === "name_desc") return b._name.localeCompare(a._name);
    return a._name.localeCompare(b._name); // name_asc
  });

  // render
  results.innerHTML = "";
  if (rows.length === 0) {
    results.innerHTML = `<div class="child-card"><div class="meta">No children match.</div></div>`;
    return;
  }

  for (const c of rows) {
    const div = document.createElement("div");
    div.className = "child-card";
    div.innerHTML = `
      <div class="name">${escapeHtml(c._name || "Unnamed Baby")}</div>
      <div class="meta">
        <span class="badge">${escapeHtml(c.stage || "—")}</span>
        <span class="badge">${c.sex === "M" ? "Boy" : c.sex === "F" ? "Girl" : "—"}</span>
      </div>
      <div class="meta" style="margin-top:6px">
        <strong>Age:</strong> ${formatAge(c)}<br/>
        <strong>Father:</strong> ${escapeHtml(c._fatherName)}<br/>
        <strong>Mother:</strong> ${escapeHtml(c.mother_user_name || c.mother_user_id || "—")}
      </div>
    `;
    results.appendChild(div);
  }
}

// helpers
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function formatAge(c){
  if (typeof c.age_days === "number") return `${c.age_days} day${c.age_days===1?"":"s"}`;
  if (c.birth_date) return new Date(c.birth_date).toLocaleDateString();
  return "—";
}
